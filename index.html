<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dear Insomnia</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;700&family=Gaegu:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="page-wrapper">
        <div class="desktop-background">
            <aside class="left-sidebar">
                <div class="profile-widget">
                    <img class="profile-img" src="profile-image.png" alt="프로필 이미지">
                    <h4 class="profile-name">My Dear Insomnia</h4>
                    <p class="profile-desc">
                        레오나 킹스칼라 x 네아 플로리안<br>
                        TWST 레오나 킹스칼라 오픈 비이입 드림
                    </p>
                </div>
                
                <nav class="sidebar-menu">
                    <a href="#" id="menu-home" class="active"><i class="fa-solid fa-house"></i> HOME</a>
                    <a href="#" id="menu-gallery"><i class="fa-solid fa-image"></i> GALLERY</a>
                    <a href="#" id="menu-character"><i class="fa-solid fa-user"></i> CHARACTER</a>
                    <a href="#" id="menu-story"><i class="fa-solid fa-book"></i> STORY</a>
                </nav>
            </aside>

            <div class="windows-area" id="windows-area">
                </div>
        </div>
        <i class="fa-solid fa-arrow-pointer desktop-cursor"></i>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const windowsArea = document.getElementById('windows-area');
            const menuLinks = document.querySelectorAll('.sidebar-menu a');

            const dDayStickerHTML = `
                <div class="d-day-sticker" id="d-day-counter-popup">
                    <span class="d-day-text">D + 0</span>
                </div>`;
            
            const calendarWindowHTML = `
                <div class="window-box calendar-window">
                    <div class="window-header">
                        <span class="window-title" id="calendar-year">YYYY</span>
                        <div class="window-buttons">
                            <i class="fa-solid fa-minus"></i> <i class="fa-regular fa-square"></i> <i class="fa-solid fa-xmark"></i>
                        </div>
                    </div>
                    <div class="window-content calendar-content">
                        <div class="month-nav">
                            <span id="prev-month" class="arrow-btn">&lt;</span>
                            <span id="month-name">Month</span>
                            <span id="next-month" class="arrow-btn">&gt;</span>
                        </div>
                        <div class="days-of-week">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div class="dates-grid" id="dates-grid"></div>
                    </div>
                </div>`;
                
            const postWindowHTML = `
                <div class="window-box gallery-window">
                    <div class="window-header">
                        <span class="window-title">Post</span>
                        <div class="window-buttons">
                            <i class="fa-solid fa-minus"></i> <i class="fa-regular fa-square"></i> <i class="fa-solid fa-xmark"></i>
                        </div>
                    </div>
                    <div class="window-content gallery-content" id="post-list-container">
                        </div>
                </div>`;
            
            // ▼▼▼▼▼ [수정] showPost 함수를 먼저 선언 ▼▼▼▼▼
            function showPost(postUrl, postTitle) {
                windowsArea.innerHTML = ''; 
                fetch(postUrl)
                    .then(response => response.text())
                    .then(postContentHTML => {
                        const postViewerHTML = `
                            <div class="window-box post-viewer-window">
                                <div class="window-header">
                                    <span class="window-title">${postTitle}</span>
                                    <div class="window-buttons">
                                        <i class="fa-solid fa-xmark" onclick="window.showHomePage()"></i>
                                    </div>
                                </div>
                                <div class="window-content post-viewer-content">
                                    ${postContentHTML}
                                </div>
                            </div>
                        `;
                        windowsArea.innerHTML = postViewerHTML; 
                    })
                    .catch(error => {
                        console.error('포스트를 불러오는 중 오류 발생:', error);
                        windowsArea.innerHTML = '<p>포스트를 불러올 수 없습니다. <a href="#" onclick="window.showHomePage()">홈으로 돌아가기</a></p>';
                    });
            }
            
            function loadPosts() {
                const postContainer = document.getElementById('post-list-container');
                if (!postContainer) return;

                fetch('posts.json')
                    .then(response => response.json())
                    .then(posts => {
                        let htmlContent = '';
                        posts.forEach(post => {
                            htmlContent += `
                                <div class="gallery-item-wrapper" onclick="showPost('${post.url}', '${post.title}')">
                                    <div class="gallery-item">
                                        <img src="${post.thumbnail}" alt="${post.title}">
                                        <p>${post.title}</p>
                                    </div>
                                </div>
                            `;
                        });
                        postContainer.innerHTML = htmlContent;
                    })
                    .catch(error => {
                        console.error('포스트 목록을 불러오는 중 오류 발생:', error);
                        postContainer.innerHTML = '<p>포스트를 불러올 수 없습니다.</p>';
                    });
            }

            function showHomePage() {
                menuLinks.forEach(l => l.classList.remove('active'));
                document.getElementById('menu-home').classList.add('active');

                windowsArea.innerHTML = dDayStickerHTML + calendarWindowHTML + postWindowHTML;
                runDday();
                runCalendar();
                runWindowFocus();
                loadPosts();
            }

            // ▼▼▼▼▼ [수정] window 객체에 함수를 할당하는 위치를 여기로 옮겼습니다 ▼▼▼▼▼
            // 함수들이 모두 선언된 이후에 전역 스코프에 할당해야 오류가 나지 않습니다.
            window.showHomePage = showHomePage;
            window.showPost = showPost;

            function clearPage() {
                windowsArea.innerHTML = '';
            }

            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    menuLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    if (this.id === 'menu-home') {
                        showHomePage();
                    } else {
                        clearPage();
                    }
                });
            });

            function runWindowFocus() {
                const windows = document.querySelectorAll('.window-box');
                let highestZIndex = 2;
                windows.forEach(window => {
                    const initialZ = window.style.zIndex ? parseInt(window.style.zIndex) : 0;
                    if(initialZ > highestZIndex) highestZIndex = initialZ;
                    window.addEventListener('mousedown', () => {
                        highestZIndex++;
                        window.style.zIndex = highestZIndex;
                    });
                });
            }

            function runDday() {
                const dDayText = document.querySelector('.d-day-text');
                if(!dDayText) return;
                const startDate = new Date('2025-06-23');
                const now = new Date();
                const todayForDday = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                
                startDate.setHours(0,0,0,0);
                todayForDday.setHours(0,0,0,0);

                const diffTime = todayForDday - startDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                dDayText.textContent = `D + ${diffDays + 1}`;
            }

            function runCalendar() {
                const monthYearElement = document.getElementById('calendar-year');
                if(!monthYearElement) return;

                const monthNameElement = document.getElementById('month-name');
                const datesGridElement = document.getElementById('dates-grid');
                const prevMonthButton = document.getElementById('prev-month');
                const nextMonthButton = document.getElementById('next-month');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                let currentDate = new Date();

                function renderCalendar() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    monthYearElement.textContent = year;
                    monthNameElement.textContent = monthNames[month];
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
                    const lastDateOfPrevMonth = new Date(year, month, 0).getDate();
                    datesGridElement.innerHTML = '';
                    for (let i = firstDayOfMonth; i > 0; i--) { datesGridElement.innerHTML += `<div class="prev-month">${lastDateOfPrevMonth - i + 1}</div>`; }
                    for (let i = 1; i <= lastDateOfMonth; i++) {
                        let classes = '';
                        const today = new Date();
                        if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { classes += ' today'; }
                        if ((month === 2 && i === 21) || (month === 6 && i === 27)) { classes += ' birthday'; }
                        if (month === 5 && i === 23) { classes += ' anniversary'; }
                        datesGridElement.innerHTML += `<div class="${classes}">${i}</div>`;
                    }
                    const totalCells = datesGridElement.children.length;
                    for (let i = 1; i <= 42 - totalCells; i++) { datesGridElement.innerHTML += `<div class="next-month">${i}</div>`; }
                }
                prevMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
                nextMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
                renderCalendar();
            }
            
            showHomePage(); // 페이지 로딩 시 홈 화면 표시
        });
    </script>
</body>
</html>
