<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000">
    <title>My Dear Insomnia</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;700&family=Gaegu:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="page-wrapper">
        <div class="desktop-background">
            <aside class="left-sidebar">
                <div class="profile-widget">
                    <img class="profile-img" src="profile-image.png" alt="프로필 이미지">
                    <h4 class="profile-name">My Dear Insomnia</h4>
                    <p class="profile-desc">
                        레오나 킹스칼라 x 네아 플로리안<br>
                        TWST 레오나 킹스칼라 오픈 비이입 드림
                    </p>
                </div>

                <nav class="sidebar-menu">
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-home" class="active"><i class="fa-solid fa-house"></i> HOME</a>
                    </div>
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-gallery"><i class="fa-solid fa-image"></i> GALLERY</a>
                    </div>
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-character"><i class="fa-solid fa-user"></i> CHARACTER</a>
                        <div class="submenu">
                            <a href="#">Leona Kingscholar</a>
                            <a href="#">Nea Florian</a>
                        </div>
                    </div>
                     <div class="menu-item-wrapper">
                        <a href="#" id="menu-story"><i class="fa-solid fa-book"></i> STORY</a>
                    </div>
                </nav>
            </aside>

            <div class="windows-area" id="windows-area">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const windowsArea = document.getElementById('windows-area');
            const menuLinks = document.querySelectorAll('.sidebar-menu a[id]');

            let galleryImages = [];
            let currentIndex = 0;

            const dDayStickerHTML = `
                <div class="d-day-sticker" id="d-day-counter-popup">
                    <span class="d-day-text">D + 0</span>
                </div>`;

            const calendarWindowHTML = `
                <div class="window-box calendar-window">
                    <div class="window-header">
                        <span class="window-title" id="calendar-year">YYYY</span>
                    </div>
                    <div class="window-content calendar-content">
                        <div class="month-nav">
                            <span id="prev-month" class="arrow-btn">&lt;</span>
                            <span id="month-name">Month</span>
                            <span id="next-month" class="arrow-btn">&gt;</span>
                        </div>
                        <div class="days-of-week">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div class="dates-grid" id="dates-grid"></div>
                    </div>
                </div>`;

            const postWindowHTML = `
                <div class="window-box gallery-window">
                    <div class="window-header">
                        <span class="window-title">Post</span>
                    </div>
                    <div class="window-content gallery-content" id="post-list-container">
                        </div>
                </div>`;

            function showPost(postUrl, postTitle) {
                windowsArea.innerHTML = '';
                fetch(postUrl)
                    .then(response => response.text())
                    .then(htmlString => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlString, 'text/html');
                        const postContentHTML = doc.body.innerHTML;

                        const postViewerHTML = `
                            <div class="window-box post-viewer-window">
                                <div class="window-header">
                                    <span class="window-title">${postTitle}</span>
                                    <div class="window-buttons">
                                        <i class="fa-solid fa-xmark" onclick="window.showHomePage()"></i>
                                    </div>
                                </div>
                                <div class="window-content post-viewer-content">
                                    ${postContentHTML}
                                </div>
                            </div>
                        `;
                        windowsArea.innerHTML = postViewerHTML;
                    })
                    .catch(error => {
                        console.error('포스트를 불러오는 중 오류 발생:', error);
                        windowsArea.innerHTML = '<p>포스트를 불러올 수 없습니다. <a href="#" onclick="window.showHomePage()">홈으로 돌아가기</a></p>';
                    });
            }

            function loadPosts() {
                const postContainer = document.getElementById('post-list-container');
                if (!postContainer) return;

                fetch('posts.json')
                    .then(response => response.json())
                    .then(posts => {
                        let htmlContent = '';
                        posts.forEach(post => {
                            htmlContent += `
                                <div class="gallery-item-wrapper" onclick="showPost('${post.url}', '${post.title}')">
                                    <div class="gallery-item">
                                        <div class="gallery-thumbnail"></div>
                                        <p>${post.title}</p>
                                    </div>
                                </div>
                            `;
                        });
                        postContainer.innerHTML = htmlContent;
                    })
                    .catch(error => {
                        console.error('포스트 목록을 불러오는 중 오류 발생:', error);
                        postContainer.innerHTML = '<p>포스트를 불러올 수 없습니다.</p>';
                    });
            }

            function showHomePage() {
                menuLinks.forEach(l => l.classList.remove('active'));
                document.getElementById('menu-home').classList.add('active');

                windowsArea.innerHTML = dDayStickerHTML + calendarWindowHTML + postWindowHTML;
                runDday();
                runCalendar();
                runWindowFocus();
                loadPosts();
            }
            
            function showGalleryPage() {
                clearPage();
                const galleryWindowHTML = `
                    <div class="window-box post-viewer-window">
                        <div class="window-header">
                            <span class="window-title">gallery</span>
                            <div class="window-buttons">
                                <i class="fa-solid fa-xmark" id="gallery-close-btn"></i>
                            </div>
                        </div>
                        <div class="window-content post-viewer-content" id="gallery-content-wrapper"></div>
                    </div>
                `;
                windowsArea.innerHTML = galleryWindowHTML;
                document.getElementById('gallery-close-btn').addEventListener('click', showGalleryGrid);
                loadGalleryImages();
            }

            function loadGalleryImages() {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                if (!galleryContentWrapper) return;
                fetch('gallery.json')
                    .then(response => response.json())
                    .then(images => {
                        galleryImages = images;
                        showGalleryGrid();
                    })
                    .catch(error => {
                        galleryContentWrapper.innerHTML = '<p>이미지를 불러올 수 없습니다.</p>';
                    });
            }

            function showGalleryGrid() {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                const closeBtn = document.getElementById('gallery-close-btn');
                if (!galleryContentWrapper || !closeBtn) return;
                closeBtn.style.display = 'none';
                galleryContentWrapper.style.padding = '20px';
                let htmlContent = '<div class="gallery-grid-container">';
                galleryImages.forEach((image, index) => {
                    htmlContent += `<img src="${image.url}" alt="${image.alt}" style="cursor: pointer;" data-index="${index}">`;
                });
                htmlContent += '</div>';
                galleryContentWrapper.innerHTML = htmlContent;
                galleryContentWrapper.querySelector('.gallery-grid-container').addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        const index = parseInt(e.target.dataset.index, 10);
                        initImageViewer(index);
                    }
                });
            }

            function initImageViewer(index) {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                const closeBtn = document.getElementById('gallery-close-btn');
                if (!galleryContentWrapper || !closeBtn) return;
                closeBtn.style.display = 'block';
                galleryContentWrapper.style.padding = '0';
                const viewerHTML = `<div class="image-viewer-wrapper"><img id="viewer-image-element" class="viewer-image"><div class="nav-button prev" id="viewer-prev-btn"><i class="fa-solid fa-chevron-left"></i></div><div class="nav-button next" id="viewer-next-btn"><i class="fa-solid fa-chevron-right"></i></div></div>`;
                galleryContentWrapper.innerHTML = viewerHTML;
                document.getElementById('viewer-prev-btn').addEventListener('click', () => navigateGallery(-1));
                document.getElementById('viewer-next-btn').addEventListener('click', () => navigateGallery(1));
                updateImageViewer(index);
            }

            function updateImageViewer(index) {
                currentIndex = index;
                const imageEl = document.getElementById('viewer-image-element');
                const prevBtn = document.getElementById('viewer-prev-btn');
                const nextBtn = document.getElementById('viewer-next-btn');
                if (!imageEl || !prevBtn || !nextBtn) return;
                imageEl.src = galleryImages[index].url;
                imageEl.alt = galleryImages[index].alt;
                prevBtn.classList.toggle('hidden', index === 0);
                nextBtn.classList.toggle('hidden', index === galleryImages.length - 1);
            }
            
            function navigateGallery(direction) {
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < galleryImages.length) {
                    updateImageViewer(newIndex);
                }
            }
            
            // ▼▼▼▼▼ [추가됨] 캐릭터 페이지 및 창 최대화 기능 ▼▼▼▼▼
            function showCharacterPage() {
                clearPage();
                const characterWindowsHTML = `
                    <div class="window-box character-window" id="leona-window">
                        <div class="window-header">
                            <span class="window-title">Leona Kingscholar</span>
                            <div class="window-buttons">
                                <i class="fa-regular fa-square maximize-btn"></i>
                            </div>
                        </div>
                        <div class="window-content">
                            <img src="leona-profile.jpg" class="character-profile-img" alt="Leona Kingscholar Profile">
                        </div>
                    </div>
                    <div class="window-box character-window" id="nea-window">
                        <div class="window-header">
                            <span class="window-title">Nea Florian</span>
                            <div class="window-buttons">
                                <i class="fa-regular fa-square maximize-btn"></i>
                            </div>
                        </div>
                        <div class="window-content">
                            </div>
                    </div>
                `;
                windowsArea.innerHTML = characterWindowsHTML;
                runWindowFocus();
            }

            function toggleMaximize(windowEl) {
                if (!windowEl) return;
                const button = windowEl.querySelector('.maximize-btn');
                
                if (windowEl.classList.contains('maximized')) {
                    // 복원
                    windowEl.classList.remove('maximized');
                    button.classList.remove('fa-window-restore');
                    button.classList.add('fa-square');
                } else {
                    // 최대화
                    windowEl.classList.add('maximized');
                    button.classList.remove('fa-square');
                    button.classList.add('fa-window-restore');
                }
            }
            // ▲▲▲▲▲ [추가됨] 캐릭터 페이지 및 창 최대화 기능 ▲▲▲▲▲

            window.showHomePage = showHomePage;
            window.showPost = showPost;

            function clearPage() {
                windowsArea.innerHTML = '';
            }

            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!this.id) return;

                    menuLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    // CHARACTER 메뉴를 클릭하면 하위메뉴가 열리던 기존 로직 제거
                    if (this.id === 'menu-home') {
                        showHomePage();
                    } else if (this.id === 'menu-gallery') {
                        showGalleryPage();
                    } else if (this.id === 'menu-character') {
                        showCharacterPage();
                    } else {
                        clearPage();
                    }
                });
            });

            // 창 제어 버튼(최대화 등)을 위한 이벤트 리스너
            windowsArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('maximize-btn')) {
                    const windowEl = e.target.closest('.window-box');
                    toggleMaximize(windowEl);
                }
            });

            function runWindowFocus() {
                const windows = document.querySelectorAll('.window-box');
                let highestZIndex = windows.length > 0 ? Math.max(...Array.from(windows).map(w => parseInt(w.style.zIndex || 0))) : 0;
                windows.forEach(window => {
                    window.addEventListener('mousedown', () => {
                        if (window.classList.contains('maximized')) return;
                        highestZIndex++;
                        window.style.zIndex = highestZIndex;
                    });
                });
            }

            function runDday() {
                const dDayText = document.querySelector('.d-day-text');
                if(!dDayText) return;
                const startDate = new Date('2025-06-23');
                const now = new Date();
                const todayForDday = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                startDate.setHours(0,0,0,0);
                todayForDday.setHours(0,0,0,0);
                const diffTime = todayForDday - startDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                dDayText.textContent = `D + ${diffDays + 1}`;
            }

            function runCalendar() {
                const monthYearElement = document.getElementById('calendar-year');
                if(!monthYearElement) return;
                const monthNameElement = document.getElementById('month-name');
                const datesGridElement = document.getElementById('dates-grid');
                const prevMonthButton = document.getElementById('prev-month');
                const nextMonthButton = document.getElementById('next-month');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                let currentDate = new Date();
                function renderCalendar() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    monthYearElement.textContent = year;
                    monthNameElement.textContent = monthNames[month];
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
                    const lastDateOfPrevMonth = new Date(year, month, 0).getDate();
                    datesGridElement.innerHTML = '';
                    for (let i = firstDayOfMonth; i > 0; i--) { datesGridElement.innerHTML += `<div class="prev-month">${lastDateOfPrevMonth - i + 1}</div>`; }
                    for (let i = 1; i <= lastDateOfMonth; i++) {
                        let classes = '';
                        const today = new Date();
                        if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) { classes += ' today'; }
                        if ((month === 2 && i === 21) || (month === 6 && i === 27)) { classes += ' birthday'; }
                        if (month === 5 && i === 23) { classes += ' anniversary'; }
                        datesGridElement.innerHTML += `<div class="${classes}">${i}</div>`;
                    }
                    const totalCells = datesGridElement.children.length;
                    for (let i = 1; i <= 42 - totalCells; i++) { datesGridElement.innerHTML += `<div class="next-month">${i}</div>`; }
                }
                prevMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
                nextMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
                renderCalendar();
            }

            showHomePage();
        });
    </script>
</body>
</html>
