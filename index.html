<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000">
    <title>My Dear Insomnia</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https="fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;700&family=Gaegu:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="page-wrapper">
        <div class="desktop-background">
            <aside class="left-sidebar">
                <div class="profile-widget">
                    <img class="profile-img" src="profile-image.png" alt="프로필 이미지">
                    <h4 class="profile-name">My Dear Insomnia</h4>
                    <p class="profile-desc">
                        레오나 킹스칼라 x 네아 플로리안<br>
                        TWST 레오나 킹스칼라 오픈 비이입 드림
                    </p>
                </div>

                <nav class="sidebar-menu">
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-home" class="active"><i class="fa-solid fa-house"></i> HOME</a>
                    </div>
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-gallery"><i class="fa-solid fa-image"></i> GALLERY</a>
                    </div>
                    <div class="menu-item-wrapper">
                        <a href="#" id="menu-character"><i class="fa-solid fa-user"></i> CHARACTER</a>
                        <div class="submenu" id="character-submenu">
                            <a href="#">Leona Kingscholar</a>
                            <a href="#">Nea Florian</a>
                        </div>
                    </div>
                     <div class="menu-item-wrapper">
                        <a href="#" id="menu-story"><i class="fa-solid fa-book"></i> STORY</a>
                    </div>
                </nav>
            </aside>

            <div class="windows-area" id="windows-area">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const windowsArea = document.getElementById('windows-area');
            const menuLinks = document.querySelectorAll('.sidebar-menu a[id]');
            const submenuLinks = document.querySelectorAll('.submenu a');

            let galleryImages = [];
            let currentIndex = 0;

            const dDayStickerHTML = `<div class="d-day-sticker" id="d-day-counter-popup"><span class="d-day-text">D + 0</span></div>`;
            const calendarWindowHTML = `<div class="window-box calendar-window"><div class="window-header"><span class="window-title" id="calendar-year">YYYY</span></div><div class="window-content calendar-content"><div class="month-nav"><span id="prev-month" class="arrow-btn">&lt;</span><span id="month-name">Month</span><span id="next-month" class="arrow-btn">&gt;</span></div><div class="days-of-week"><span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span></div><div class="dates-grid" id="dates-grid"></div></div></div>`;
            const postWindowHTML = `<div class="window-box gallery-window"><div class="window-header"><span class="window-title">Post</span></div><div class="window-content gallery-content" id="post-list-container"></div></div>`;

            function showPost(postUrl, postTitle) {
                windowsArea.innerHTML = '';
                fetch(postUrl)
                    .then(response => response.text())
                    .then(htmlString => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlString, 'text/html');
                        const postContentHTML = doc.body.innerHTML;
                        const postViewerHTML = `<div class="window-box post-viewer-window"><div class="window-header"><span class="window-title">${postTitle}</span><div class="window-buttons"><i class="fa-solid fa-xmark" onclick="window.showHomePage()"></i></div></div><div class="window-content post-viewer-content">${postContentHTML}</div></div>`;
                        windowsArea.innerHTML = postViewerHTML;
                    })
                    .catch(error => {
                        console.error('포스트를 불러오는 중 오류 발생:', error);
                        windowsArea.innerHTML = `<p>포스트를 불러올 수 없습니다. <a href="#" onclick="window.showHomePage()">홈으로 돌아가기</a></p>`;
                    });
            }

            function loadPosts() {
                const postContainer = document.getElementById('post-list-container');
                if (!postContainer) return;
                fetch('posts.json')
                    .then(response => response.json())
                    .then(posts => {
                        let htmlContent = '';
                        posts.forEach(post => {
                            htmlContent += `<div class="gallery-item-wrapper" onclick="showPost('${post.url}', '${post.title}')"><div class="gallery-item"><div class="gallery-thumbnail"></div><p>${post.title}</p></div></div>`;
                        });
                        postContainer.innerHTML = htmlContent;
                    })
                    .catch(error => {
                        console.error('포스트 목록을 불러오는 중 오류 발생:', error);
                        postContainer.innerHTML = '<p>포스트를 불러올 수 없습니다.</p>';
                    });
            }

            function showHomePage() {
                document.getElementById('character-submenu').classList.remove('open');
                menuLinks.forEach(l => l.classList.remove('active'));
                document.getElementById('menu-home').classList.add('active');
                windowsArea.innerHTML = dDayStickerHTML + calendarWindowHTML + postWindowHTML;
                runDday();
                runCalendar();
                runWindowFocus();
                loadPosts(); 
            }
            
            function showGalleryPage() {
                clearPage();
                const galleryWindowHTML = `<div class="window-box post-viewer-window"><div class="window-header"><span class="window-title">gallery</span><div class="window-buttons"><i class="fa-solid fa-xmark" id="gallery-close-btn"></i></div></div><div class="window-content post-viewer-content" id="gallery-content-wrapper"></div></div>`;
                windowsArea.innerHTML = galleryWindowHTML;
                document.getElementById('gallery-close-btn').addEventListener('click', showGalleryGrid);
                loadGalleryImages();
            }

            function loadGalleryImages() {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                if (!galleryContentWrapper) return;
                fetch('gallery.json')
                    .then(response => response.json())
                    .then(images => { galleryImages = images; showGalleryGrid(); })
                    .catch(error => { galleryContentWrapper.innerHTML = '<p>이미지를 불러올 수 없습니다.</p>'; });
            }

            function showGalleryGrid() {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                const closeBtn = document.getElementById('gallery-close-btn');
                if (!galleryContentWrapper || !closeBtn) return;
                closeBtn.style.display = 'none';
                galleryContentWrapper.style.padding = '20px';
                let htmlContent = '<div class="gallery-grid-container">';
                galleryImages.forEach((image, index) => {
                    htmlContent += `<img src="${image.url}" alt="${image.alt}" style="cursor: pointer;" data-index="${index}">`;
                });
                htmlContent += '</div>';
                galleryContentWrapper.innerHTML = htmlContent;
                galleryContentWrapper.querySelector('.gallery-grid-container').addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        initImageViewer(parseInt(e.target.dataset.index, 10));
                    }
                });
            }

            function initImageViewer(index) {
                const galleryContentWrapper = document.getElementById('gallery-content-wrapper');
                const closeBtn = document.getElementById('gallery-close-btn');
                if (!galleryContentWrapper || !closeBtn) return;
                closeBtn.style.display = 'block';
                galleryContentWrapper.style.padding = '0';
                const viewerHTML = `<div class="image-viewer-wrapper"><img id="viewer-image-element" class="viewer-image"><div class="nav-button prev" id="viewer-prev-btn"><i class="fa-solid fa-chevron-left"></i></div><div class="nav-button next" id="viewer-next-btn"><i class="fa-solid fa-chevron-right"></i></div></div>`;
                galleryContentWrapper.innerHTML = viewerHTML;
                document.getElementById('viewer-prev-btn').addEventListener('click', () => navigateGallery(-1));
                document.getElementById('viewer-next-btn').addEventListener('click', () => navigateGallery(1));
                updateImageViewer(index);
            }

            function updateImageViewer(index) {
                currentIndex = index;
                const imageEl = document.getElementById('viewer-image-element');
                const prevBtn = document.getElementById('viewer-prev-btn');
                const nextBtn = document.getElementById('viewer-next-btn');
                if (!imageEl || !prevBtn || !nextBtn) return;
                imageEl.src = galleryImages[index].url;
                imageEl.alt = galleryImages[index].alt;
                prevBtn.classList.toggle('hidden', index === 0);
                nextBtn.classList.toggle('hidden', index === galleryImages.length - 1);
            }
            
            function navigateGallery(direction) {
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex < galleryImages.length) {
                    updateImageViewer(newIndex);
                }
            }
            
            // ▼▼▼▼▼ [수정됨] 캐릭터 페이지 및 창 최대화/사이즈 조절 기능 ▼▼▼▼▼
            function showCharacterPage() {
                clearPage();
                const characterWindowsHTML = `
                    <div class="window-box character-window" id="leona-window">
                        <div class="window-header"><span class="window-title">Leona Kingscholar</span><div class="window-buttons"><i class="fa-regular fa-square maximize-btn"></i></div></div>
                        <div class="window-content">
                            <img src="leona-profile.jpg" class="character-profile-img" id="leona-profile-img" alt="Leona Kingscholar Profile">
                        </div>
                    </div>
                    <div class="window-box character-window" id="nea-window">
                        <div class="window-header"><span class="window-title">Nea Florian</span><div class="window-buttons"><i class="fa-regular fa-square maximize-btn"></i></div></div>
                        <div class="window-content">
                            <img src="nea-profile.jpg" class="character-profile-img" alt="Nea Florian Profile">
                        </div>
                    </div>
                `;
                windowsArea.innerHTML = characterWindowsHTML;

                const leonaImg = document.getElementById('leona-profile-img');
                const leonaWindow = document.getElementById('leona-window');
                const neaWindow = document.getElementById('nea-window');
                
                const setWindowHeights = () => {
                    const imgWidth = leonaImg.naturalWidth;
                    const imgHeight = leonaImg.naturalHeight;
                    const windowWidth = leonaWindow.offsetWidth;
                    const newContentHeight = (imgHeight / imgWidth) * windowWidth;
                    const newWindowHeight = newContentHeight + 28; // 헤더 높이(28px) 추가
                    leonaWindow.style.height = `${newWindowHeight}px`;
                    neaWindow.style.height = `${newWindowHeight}px`;
                };

                if (leonaImg.complete) {
                    setWindowHeights();
                } else {
                    leonaImg.onload = setWindowHeights;
                }

                runWindowFocus();
            }

            function toggleMaximize(windowEl) {
                if (!windowEl) return;
                const button = windowEl.querySelector('.maximize-btn');
                if (windowEl.classList.contains('maximized')) {
                    windowEl.classList.remove('maximized');
                    windowEl.style.top = windowEl.dataset.originalTop;
                    windowEl.style.left = windowEl.dataset.originalLeft;
                    windowEl.style.width = windowEl.dataset.originalWidth;
                    windowEl.style.height = windowEl.dataset.originalHeight;
                    button.classList.remove('fa-window-restore');
                    button.classList.add('fa-square');
                } else {
                    const windowRect = windowEl.getBoundingClientRect();
                    const containerRect = windowsArea.getBoundingClientRect();
                    windowEl.dataset.originalTop = getComputedStyle(windowEl).top;
                    windowEl.dataset.originalLeft = getComputedStyle(windowEl).left;
                    windowEl.dataset.originalWidth = `${windowRect.width}px`;
                    windowEl.dataset.originalHeight = `${windowRect.height}px`;
                    const margin = 40;
                    const availableWidth = containerRect.width - margin;
                    const availableHeight = containerRect.height - margin;
                    const windowRatio = windowRect.width / windowRect.height;
                    const containerRatio = availableWidth / availableHeight;
                    let newWidth, newHeight;
                    if (containerRatio > windowRatio) {
                        newHeight = availableHeight;
                        newWidth = newHeight * windowRatio;
                    } else {
                        newWidth = availableWidth;
                        newHeight = newWidth / windowRatio;
                    }
                    windowEl.classList.add('maximized');
                    windowEl.style.top = `${(containerRect.height - newHeight) / 2}px`;
                    windowEl.style.left = `${(containerRect.width - newWidth) / 2}px`;
                    windowEl.style.width = `${newWidth}px`;
                    windowEl.style.height = `${newHeight}px`;
                    button.classList.remove('fa-square');
                    button.classList.add('fa-window-restore');
                }
            }
            // ▲▲▲▲▲ [수정됨] 캐릭터 페이지 및 창 최대화/사이즈 조절 기능 ▲▲▲▲▲

            function clearPage() {
                windowsArea.innerHTML = '';
            }
            
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!this.id) return;
                    
                    const characterSubmenu = document.getElementById('character-submenu');
                    
                    if (this.id === 'menu-character') {
                        this.classList.toggle('active');
                        characterSubmenu.classList.toggle('open');
                        if (this.classList.contains('active')) {
                            showCharacterPage();
                            menuLinks.forEach(l => { if(l.id !== 'menu-character') l.classList.remove('active'); });
                        } else {
                            clearPage();
                        }
                    } else {
                        menuLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        characterSubmenu.classList.remove('open');
                        
                        if (this.id === 'menu-home') { showHomePage(); } 
                        else if (this.id === 'menu-gallery') { showGalleryPage(); } 
                        else { clearPage(); }
                    }
                });
            });

            submenuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    clearPage();
                    menuLinks.forEach(l => l.classList.remove('active'));
                    document.getElementById('character-submenu').classList.remove('open');
                });
            });

            windowsArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('maximize-btn')) {
                    toggleMaximize(e.target.closest('.window-box'));
                }
            });
            
            function runWindowFocus() {
                const windows = document.querySelectorAll('.window-box');
                let highestZIndex = windows.length > 0 ? Math.max(...Array.from(windows).map(w => parseInt(getComputedStyle(w).zIndex) || 0)) : 0;
                windows.forEach(window => {
                    window.addEventListener('mousedown', () => {
                        if (window.classList.contains('maximized')) return;
                        highestZIndex++;
                        window.style.zIndex = highestZIndex;
                    });
                });
            }

            function runDday() { /* ... */ }
            function runCalendar() { /* ... */ }

            showHomePage();
        });
    </script>
</body>
</html>
